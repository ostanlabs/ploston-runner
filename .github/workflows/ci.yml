# =============================================================================
# Ploston Runner CI Workflow
# =============================================================================
# Runs lint and unit tests, reports to meta-repo.
#
# Triggers:
#   - Push to main: Full CI + trigger meta-repo integration tests
#   - Pull request: Lint + unit tests only
#   - workflow_dispatch: Triggered by meta-repo for coordinated builds
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      ploston_core_version:
        description: 'ploston-core version to use (PyPI version like 1.4.0.dev1738800000). Empty = latest PyPI'
        required: false
        default: ''
      meta_run_id:
        description: 'Meta-repo run ID (for callback)'
        required: false
        default: ''

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run lint
        run: make lint

  unit-tests:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Create venv and install dependencies
        run: |
          uv venv
          uv sync --all-extras

      - name: Wait for ploston-core on PyPI (if specific version provided)
        if: inputs.ploston_core_version != ''
        run: |
          PACKAGE="ploston-core"
          VERSION="${{ inputs.ploston_core_version }}"
          MAX_ATTEMPTS=12
          SLEEP_INTERVAL=10

          echo "Waiting for ${PACKAGE}==${VERSION} to be available on PyPI..."
          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/${PACKAGE}/${VERSION}/json")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ ${PACKAGE}==${VERSION} is available on PyPI (attempt $i)"
              exit 0
            else
              echo "⏳ Waiting for ${PACKAGE}==${VERSION} on PyPI (attempt $i/$MAX_ATTEMPTS, HTTP $HTTP_CODE)..."
              if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
                sleep $SLEEP_INTERVAL
              fi
            fi
          done
          echo "⚠️ Timeout waiting for ${PACKAGE}==${VERSION}, proceeding anyway..."

      - name: Install specific ploston-core version (if provided)
        if: inputs.ploston_core_version != ''
        run: |
          echo "Installing ploston-core==${{ inputs.ploston_core_version }}"
          uv pip install "ploston-core==${{ inputs.ploston_core_version }}"

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v --tb=short --junitxml=junit-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: junit-results.xml

  # ===========================================================================
  # Report Results to Meta-Repo
  # ===========================================================================

  # Report completion when triggered by meta-repo (workflow_dispatch)
  report-completion:
    needs: [lint, unit-tests]
    if: always() && github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Report CI completion to meta-repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: package-ci-complete
          client-payload: |
            {
              "package": "ploston-runner",
              "sha": "${{ github.sha }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "meta_run_id": "${{ inputs.meta_run_id }}",
              "status": "${{ needs.unit-tests.result == 'success' && 'success' || 'failure' }}"
            }

  # Trigger meta-repo CI when this repo changes organically (push to main)
  trigger-meta-repo:
    needs: unit-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.unit-tests.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger meta-repo CI
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: component-updated
          client-payload: |
            {
              "trigger_repo": "ploston-runner",
              "trigger_sha": "${{ github.sha }}"
            }

  report-to-dashboard:
    name: Report to Dashboard
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-results
          path: test-results/

      - name: Parse test results
        id: parse
        run: |
          TOTAL_TESTS=0
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_SKIPPED=0

          if [ -d "test-results" ]; then
            for xml in test-results/*.xml; do
              if [ -f "$xml" ]; then
                TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml" | head -1 || echo 0)
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml" | head -1 || echo 0)
                ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml" | head -1 || echo 0)
                SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$xml" | head -1 || echo 0)

                TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                TOTAL_FAILED=$((TOTAL_FAILED + FAILURES + ERRORS))
                TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))
              fi
            done
          fi

          TOTAL_PASSED=$((TOTAL_TESTS - TOTAL_FAILED - TOTAL_SKIPPED))

          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT

      - name: Get short SHA
        id: sha
        run: echo "short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Report to meta-repo dashboard
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: ci-results-ploston-runner
          client-payload: |
            {
              "package": "ploston-runner",
              "sha": "${{ github.sha }}",
              "short_sha": "${{ steps.sha.outputs.short }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "lint": "${{ needs.lint.result }}",
              "test": "${{ needs.unit-tests.result }}",
              "tests": {
                "total": ${{ steps.parse.outputs.total }},
                "passed": ${{ steps.parse.outputs.passed }},
                "failed": ${{ steps.parse.outputs.failed }},
                "skipped": ${{ steps.parse.outputs.skipped }}
              },
              "status": "${{ needs.lint.result == 'success' && needs.unit-tests.result == 'success' && 'success' || 'failure' }}"
            }
